# 地图区域编辑使用指南

## ✅ 已完成的修改

### 1. Size 列完全锁定 ✓
- `AllowEdit = false` - 禁止编辑
- `ReadOnly = true` - 只读
- `AllowFocus = false` - 禁止聚焦（灰色显示）
- `TabStop = false` - 禁止 Tab 键选中

### 2. 新增坐标生成区域功能 ✓
- 添加了坐标输入面板（位于表格上方）
- 支持输入左上角和右下角坐标
- 自动生成矩形选择区域
- 自动验证坐标范围

### 3. 修复 MapViewer 鼠标交互 ✓
- 添加了 Map 对象 null 检查，防止崩溃
- 默认启用选择区域显示（DrawSelection = true）
- 确保鼠标事件正确传递到 MapControl

### 4. 新增双击查看区域信息 ✓
- 双击表格中的区域可查看详细边界信息

---

## 📖 使用方法

### 【方法一】手动绘制区域

#### 步骤 1: 创建新区域
1. 点击表格顶部的 "+" 号（新建行）
2. 填写基本信息：
   - **地图**: 选择目标地图（必填）
   - **区域描述**: 输入名称（如"安全区"）
   - **区域类型**: 选择类型（Area/Line 等）
   - **Size**: 自动计算 ✓ 锁定不可编辑

#### 步骤 2: 打开地图编辑器
3. 点击该行的 **"编辑"** 按钮
4. MapViewer 窗口打开并加载地图

#### 步骤 3: 使用鼠标绘制区域
```
🖱️ 左键拖拽      添加格子到选择区（画笔）
🖱️ 右键拖拽      从选择区移除格子（橡皮擦）
🖱️ 中键点击      智能填充连通区域（洪水填充）
🔄 鼠标滚轮      调整画笔半径（0-10）
```

**观察状态栏：**
```
Map Size: 200, 200          (地图总大小)
Position: 45, 30            (当前鼠标坐标)
Selected Cells: 150         (已选中格子数)
```

#### 步骤 4: 保存
5. 点击 MapViewer 的 **"Save"** 按钮
   → Size 自动更新为选中格子数
6. 点击 MapRegionView 的 **"保存数据库"**
   → 持久化到数据库 ✓

---

### 【方法二】坐标快速生成区域（新功能！）

#### 使用坐标生成面板

**面板位置：** 表格上方的"坐标生成区域"面板

**输入框说明：**
```
┌─────────────────────────────────────┐
│  左上 X: [____]  右下 X: [____]      │
│  左上 Y: [____]  右下 Y: [____]      │
│              [生成区域]              │
└─────────────────────────────────────┘
```

#### 操作步骤：
1. **在表格中选择**要编辑的区域（必须已设置地图）
2. **输入坐标**：
   ```
   示例：创建 20x20 的矩形区域
   左上 X: 100    右下 X: 119
   左上 Y: 50     右下 Y: 69
   ```
3. **点击"生成区域"按钮**
4. **自动完成**：
   - ✓ 自动打开 MapViewer
   - ✓ 自动生成矩形选择区域
   - ✓ 自动保存到 MapRegion 对象
   - ✓ 显示确认信息

**成功提示：**
```
已生成区域！
起始坐标: (100, 50)
结束坐标: (119, 69)
区域大小: 400 格
```

#### 坐标验证：
- ✓ 自动检查坐标是否为有效数字
- ✓ 自动校正坐标顺序（左上到右下）
- ✓ 验证坐标是否超出地图范围
- ✓ 如果输入错误会弹出提示

---

### 【方法三】查看区域信息

#### 双击查看详细信息
**操作：** 双击表格中的任意区域

**显示内容：**
```
┌──────────────────────────────┐
│ 区域信息 - 安全区            │
├──────────────────────────────┤
│ 起始坐标: (45, 30)           │
│ 结束坐标: (65, 55)           │
│ 矩形尺寸: 21 x 26 (546 格)   │
│ 实际大小: 150 格             │
│ 填充率: 27.5%                │
└──────────────────────────────┘
```

**填充率说明：**
- 100%: 完整的矩形区域
- <100%: 不规则形状（有空洞或凹陷）
- 例：27.5% 表示只选中了矩形框内 27.5% 的格子

---

## 🎮 MapViewer 工具栏功能

### 缩放控制
```
Reset      恢复 1x 缩放
Zoom In    放大 (2x, 最大 4x)
Zoom Out   缩小 (0.5x, 最小 0.01x)
```

### 显示开关
```
Attributes            显示/隐藏阻挡格（红色高亮）
Selection             显示/隐藏选择区（黄色高亮）
Attribute Selection   仅操作有属性的格子
```

### 数据操作
```
Save      保存当前选择到 MapRegion（内存）
Cancel    取消修改，恢复为原始选择
```

---

## 💡 实用技巧

### 画笔半径使用
```
Radius = 0   单格选择（精确）
Radius = 2   5x5 正方形刷子
Radius = 5   11x11 正方形刷子
```
**调整方法：** 鼠标滚轮上下滚动

### 智能填充（中键）
```
适用场景：选择房间、走廊等封闭区域
操作：中键点击区域内任意格子
效果：自动填充所有连通的可行走格子
```

### 快速框选技巧
```
1. 调大半径（滚轮向上）
2. 左键沿边缘快速拖拽
3. 调小半径修正边界
4. 中键填充内部
```

### 坐标生成的最佳实践
```
✓ 适合：规则矩形区域（安全区、传送点区域）
✓ 优势：精确、快速、可重复
✓ 组合：先用坐标生成基础形状，再用鼠标微调
```

---

## 🔧 故障排除

### Q1: 鼠标无法在 MapViewer 中绘制？
**检查项：**
- ✓ 确认已选择了一个区域并点击"编辑"
- ✓ 等待地图加载完成（状态栏显示地图大小）
- ✓ 确认鼠标在地图区域内（不是工具栏）
- ✓ 检查是否启用了 "Selection" 显示

### Q2: 生成区域按钮无响应？
**检查项：**
- ✓ 确认已在表格中选中一个区域
- ✓ 确认该区域已设置地图
- ✓ 检查坐标输入是否为有效数字
- ✓ 查看是否有错误提示对话框

### Q3: Size 列还能编辑？
**原因：** 可能是旧版本
**解决：** 重新编译项目，确保使用最新的 Designer 代码

### Q4: 双击无法显示区域信息？
**检查项：**
- ✓ 确认区域的 Size 大于 0
- ✓ 确认区域已设置地图
- ✓ 双击的是数据行，不是表头

---

## 📊 使用场景示例

### 示例 1: 创建安全区
```
方法：坐标生成
左上坐标: (330, 280)
右下坐标: (350, 300)
区域大小: 21 x 21 = 441 格
用途：玩家在此区域内不能被 PK
```

### 示例 2: 创建传送点
```
方法：坐标生成
左上坐标: (100, 100)
右下坐标: (102, 102)
区域大小: 3 x 3 = 9 格
用途：配合 MovementInfo 实现地图传送
```

### 示例 3: 创建不规则怪物刷新区
```
方法：手动绘制
1. 用坐标生成大致范围
2. 用右键删除不需要的格子（如建筑内部）
3. 用中键填充连通区域
4. 最终填充率: 45%（不规则形状）
```

---

## 📝 注意事项

1. **数据保存流程：**
   ```
   MapViewer "Save" → 保存到 MapRegion 对象（内存）
   MapRegionView "保存数据库" → 持久化到数据库
   ```

2. **坐标系统：**
   - 原点 (0, 0) 位于地图**左上角**
   - X 轴向右递增
   - Y 轴向下递增

3. **性能建议：**
   - 大型区域（>10000格）建议使用坐标生成
   - 复杂形状区域建议使用手动绘制
   - 定期保存避免数据丢失

4. **备份建议：**
   - 修改重要区域前先导出 JSON 备份
   - 使用 "Json 导入导出" 功能

---

## 🎯 快捷键总结

```
MapViewer 窗口：
├─ 鼠标滚轮      调整画笔半径
├─ 左键          添加格子
├─ 右键          删除格子
└─ 中键          智能填充

表格操作：
├─ 双击          查看区域详细信息
└─ Ctrl+S        保存数据库（如果支持）
```

---

**更新日期：** 2026年2月10日  
**版本：** 1.0  
**作者：** AI Assistant
